<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñdeme Takip Paneli</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        /* Added for file input styling */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .top-right {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .currency-rates {
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
            flex-wrap: wrap;
        }

        .rate-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .rate-value {
            color: #667eea;
            font-size: 1.1em;
        }

        .table-container {
            overflow-x: auto;
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-paid {
            color: #28a745;
            font-weight: 600;
        }

        .status-pending {
            color: #dc3545;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 50px auto;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5em;
        }

        .close {
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .summary {
            padding: 20px 30px;
            background: #e7f3ff;
            border-top: 2px solid #667eea;
        }

        .summary h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .summary-item h4 {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 1.3em;
            font-weight: 700;
            color: #212529;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="top-right">
                <!-- Settings Removed for Auto-Sync -->
            </div>
            <h1>üíº √ñdeme Takip Paneli</h1>
            <p>Ocak 2026 D√∂nemi - Ferit Abi Tablosu</p>
            <div id="syncStatus" style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                Durum: <span id="connectionState">üî¥ Baƒülƒ± Deƒüil</span>
            </div>
        </div>

        <div class="currency-rates">
            <div class="rate-item">
                <span>USD:</span>
                <span class="rate-value" id="usdRate">‚Ç∫43.10</span>
            </div>
            <div class="rate-item">
                <span>EUR:</span>
                <span class="rate-value" id="eurRate">‚Ç∫50.00</span>
            </div>
            <div class="rate-item">
                <span>STG:</span>
                <span class="rate-value" id="stgRate">‚Ç∫57.80</span>
            </div>
            <div class="rate-item">
                <span>STG/EUR:</span>
                <span class="rate-value">1.16</span>
            </div>
            <div class="rate-item">
                <span>USD/EUR:</span>
                <span class="rate-value">0.86</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">‚ûï Yeni Kayƒ±t Ekle</button>
            <button class="btn btn-info" onclick="openReportsModal()">üìà Raporlar & Ge√ßmi≈ü</button>
            <button class="btn btn-success" onclick="exportToExcel()">üìä Excel'e Aktar</button>
            <div class="file-upload-wrapper">
                <button class="btn btn-warning">üìÇ Excel'den Y√ºkle</button>
                <input type="file" id="excelImportInput" accept=".xlsx, .xls" onchange="importExcel(event)" />
            </div>
            <button class="btn btn-info" onclick="updateCurrencyRates()">üí± Kur G√ºncelle</button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Ara... (Firma, i≈ü adƒ±, √∂deme kalemi)"
                    onkeyup="filterTable()">
            </div>
        </div>

        <div class="table-container">
            <table id="paymentsTable">
                <thead>
                    <tr>
                        <th>Sƒ±ra No</th>
                        <th>√ñdeme Kalemleri</th>
                        <th>Firma Fatura ƒ∞smi</th>
                        <th>Firma ƒ∞banlarƒ±</th>
                        <th>ƒ∞≈üin Nevi</th>
                        <th>Fatura Durumu</th>
                        <th>ƒ∞≈üin Adƒ±</th>
                        <th>Para Birimi</th>
                        <th>√ñnceki D√∂nemden Kalan Bor√ß</th>
                        <th>Bu Ayki Bor√ß</th>
                        <th>Toplam Bor√ß</th>
                        <th>Bu Ay √ñdenen</th>
                        <th>Kalan</th>
                        <th>√ñdeme Durumu</th>
                        <th>Evrak Y√ºkleme (PDF-JPG)</th>
                        <th>ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="summary">
            <h3>üìà √ñzet Bilgiler</h3>
            <div class="summary-grid" id="summaryGrid">
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Yeni √ñdeme Kaydƒ±</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="paymentForm" class="form-grid">
                    <input type="hidden" id="editIndex">

                    <div class="form-group">
                        <label>√ñdeme Kalemi *</label>
                        <input type="text" id="paymentItem" required>
                    </div>

                    <div class="form-group">
                        <label>Firma ƒ∞smi *</label>
                        <input type="text" id="companyName" required>
                    </div>

                    <div class="form-group">
                        <label>ƒ∞≈üin Nevi *</label>
                        <select id="workType" required>
                            <option value="">Se√ßiniz</option>
                            <option value="TA≈ûERON">TA≈ûERON</option>
                            <option value="MALZEME TEDARƒ∞ƒûƒ∞">MALZEME TEDARƒ∞ƒûƒ∞</option>
                            <option value="NAKLƒ∞YE">NAKLƒ∞YE</option>
                            <option value="RESMƒ∞ KURUM HAR√áLARI">RESMƒ∞ KURUM HAR√áLARI</option>
                            <option value="MAKƒ∞NE EKƒ∞PMAN">MAKƒ∞NE EKƒ∞PMAN</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Fatura Durumu *</label>
                        <select id="invoiceStatus" required>
                            <option value="">Se√ßiniz</option>
                            <option value="FATURALI">FATURALI</option>
                            <option value="FATURASIZ">FATURASIZ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ƒ∞≈üin Adƒ± *</label>
                        <input type="text" id="workName" required>
                    </div>

                    <div class="form-group">
                        <label>Para Birimi *</label>
                        <select id="currency" required>
                            <option value="">Se√ßiniz</option>
                            <option value="TL">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="STG">STG</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>√ñnceki D√∂nem Bor√ß</label>
                        <input type="number" id="previousDebt" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label>Bu Ay Bor√ß</label>
                        <input type="number" id="currentDebt" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label>Bu Ay √ñdenen</label>
                        <input type="number" id="paid" step="0.01" value="0">
                    </div>

                    <div class="form-group full-width">
                        <label>Firma ƒ∞banlarƒ±</label>
                        <input type="text" id="iban" placeholder="TR00 0000 0000 0000 0000 0000 00">
                    </div>

                    <div class="form-group full-width">
                        <label>Evrak Y√ºkleme (PDF-JPG)</label>
                        <input type="file" id="documentInput" accept=".pdf,.jpg,.jpeg,.png">
                        <small style="color: #666; margin-top: 5px;" id="currentDocLabel"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal()">ƒ∞ptal</button>
                <button class="btn btn-success" onclick="savePayment()">üíæ Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal Removed -->

    <script>
        // --- Vercel Serverless Service ---
        class GitHubService {
            constructor() {
                this.apiUrl = '/api/sync';
                this.sha = null;
            }

            get isConfigured() {
                return true; // Server handles keys
            }

            async loadData() {
                updateStatus('üîÑ Veriler √ßekiliyor...', '#ffc107');
                try {
                    const response = await fetch(`${this.apiUrl}?path=data.json&t=${new Date().getTime()}`);

                    if (response.status === 404) {
                        updateStatus('üü¢ Yeni Veri Tabanƒ±', '#28a745');
                        return null;
                    }
                    if (!response.ok) throw new Error('API Error');

                    const data = await response.json();
                    this.sha = data.sha;

                    // GitHub API returns content in base64
                    const content = decodeURIComponent(escape(atob(data.content)));
                    return JSON.parse(content);
                } catch (error) {
                    console.error("Load Error:", error);
                    updateStatus('üî¥ API Hatasƒ± (Vercel)', '#dc3545');
                    return null;
                }
            }

            async saveData(data) {
                updateStatus('üîÑ Kaydediliyor...', '#17a2b8');
                try {
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: 'data.json',
                            message: `Update ${new Date().toISOString()}`,
                            content: content,
                            sha: this.sha
                        })
                    });

                    const resData = await response.json();

                    if (!response.ok) {
                        alert(`‚ùå Kayƒ±t Ba≈üarƒ±sƒ±z!\nHata: ${resData.error || 'Bilinmeyen Hata'}\nDetay: ${JSON.stringify(resData.details || '')}`);
                        throw new Error(resData.error || 'Save Failed');
                    }

                    this.sha = resData.content.sha;
                    updateStatus('üü¢ Kaydedildi', '#28a745');
                    return true;
                } catch (error) {
                    console.error("Save Error:", error);
                    updateStatus('üî¥ Kayƒ±t Ba≈üarƒ±sƒ±z', '#dc3545');
                    return false;
                }
            }

            async uploadFile(file) {
                updateStatus('üîÑ Dosya Y√ºkleniyor...', '#17a2b8');
                try {
                    const timestamp = new Date().getTime();
                    const filename = `uploads/${timestamp}_${file.name}`;

                    const toBase64 = file => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                    });

                    const content = await toBase64(file);

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: filename,
                            message: `Upload ${file.name}`,
                            content: content
                        })
                    });

                    const resData = await response.json();

                    if (!response.ok) {
                        alert(`‚ùå Dosya Y√ºkleme Hatasƒ±!\nHata: ${resData.error || 'Bilinmeyen Hata'}`);
                        throw new Error('Upload Failed');
                    }

                    updateStatus('üü¢ Dosya Y√ºklendi', '#28a745');
                    return resData.content.download_url;
                } catch (error) {
                    console.error("Upload Error:", error);
                    updateStatus('üî¥ Dosya Y√ºklenemedi', '#dc3545');
                    return null;
                }
            }

            async checkForUpdates() {
                try {
                    // Add timestamp to bypass browser cache
                    const response = await fetch(`${this.apiUrl}?path=data.json&t=${new Date().getTime()}`);
                    if (!response.ok) return false;
                    const data = await response.json();
                    return data.sha !== this.sha;
                } catch (e) { return false; }
            }
        }

        const gitHub = new GitHubService();

        // --- Configuration ---
        const DEFAULT_USER = "gokturk078";
        const DEFAULT_REPO = "yarrak-tassak";
        // Token is NOT hardcoded for security. User must enter it once.

        // --- Initial Data (Ferit Abi Tablosu) ---
        const DEFAULT_PAYMENTS = [
            { paymentItem: "SGK (REPSAM)", companyName: "KEMAL BATMAZOƒûLU", iban: "", workType: "RESMƒ∞ KURUM HAR√áLARI", invoiceStatus: "FATURALI", workName: "GZ", currency: "TL", previousDebt: 565.00, currentDebt: 0, paid: 0, documentName: "" },
            { paymentItem: "RESMƒ∞ MUHASEBE Gƒ∞DERƒ∞", companyName: "KEMAL BATMAZOƒûLU", iban: "", workType: "RESMƒ∞ KURUM HAR√áLARI", invoiceStatus: "FATURASIZ", workName: "CNN", currency: "TL", previousDebt: 565.00, currentDebt: 0, paid: 0, documentName: "" },
            { paymentItem: "SGK(CAPRA)", companyName: "ERG√úN DOLMACI & Co.", iban: "", workType: "RESMƒ∞ KURUM HAR√áLARI", invoiceStatus: "FATURALI", workName: "ASKERƒ∞YE", currency: "TL", previousDebt: 565.00, currentDebt: 5000.00, paid: 150000.00, documentName: "fatura.pdf" },
            { paymentItem: "SU FATURALARI", companyName: "", iban: "", workType: "RESMƒ∞ KURUM HAR√áLARI", invoiceStatus: "FATURASIZ", workName: "MERƒ∞T", currency: "TL", previousDebt: 565.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ELEKTRƒ∞K FATURALARI", companyName: "", iban: "", workType: "RESMƒ∞ KURUM HAR√áLARI", invoiceStatus: "FATURALI", workName: "BALO", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "√ñMER Dƒ∞LMA√á", companyName: "√ñMER Dƒ∞LMA√á", iban: "", workType: "NAKLƒ∞YE", invoiceStatus: "FATURASIZ", workName: "KANER", currency: "USD", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "dekont.jpg" },
            { paymentItem: "√ñMER Dƒ∞LMA√á", companyName: "√ñMER Dƒ∞LMA√á", iban: "", workType: "NAKLƒ∞YE", invoiceStatus: "FATURALI", workName: "GZ", currency: "TL", previousDebt: 25000.00, currentDebt: 154268.00, paid: 150000.00, documentName: "" },
            { paymentItem: "TDA OTO (Honda & Yaris)", companyName: "DEMƒ∞R BA≈û", iban: "", workType: "", invoiceStatus: "FATURASIZ", workName: "GZ", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ENVER D√úZKAR", companyName: "ENVER D√úZKAR", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURALI", workName: "ETKƒ∞NLƒ∞K MEYDANI", currency: "STG", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "EDƒ∞Z METAL", companyName: "KAƒ∞Z TRADING LTD", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "MUTFAK", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ALƒ∞ √áELƒ∞K (GZ OTEL BLOK DUVAR ƒ∞≈ûLERƒ∞)", companyName: "ALƒ∞ √áELƒ∞K", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURALI", workName: "GZ", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "KEMAL G√úRE≈û√áƒ∞OƒûLU", companyName: "", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "ƒ∞≈û√áƒ∞ LOJMAN", currency: "EUR", previousDebt: 25000.00, currentDebt: 154268.00, paid: 150000.00, documentName: "" },
            { paymentItem: "OYTUN YUNAK", companyName: "OYTUN YUNAK", iban: "", workType: "MALZEME TEDARƒ∞ƒûƒ∞", invoiceStatus: "FATURALI", workName: "DOME TAKSƒ∞", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "CONAK ARD GERME", companyName: "", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "GZ", currency: "EUR", previousDebt: 25000.00, currentDebt: 154268.00, paid: 150000.00, documentName: "" },
            { paymentItem: "EDNA ERSOYOƒûLU (ƒ∞≈û√áƒ∞ LOJMAN ƒ∞NCE TEMƒ∞ZLƒ∞K)", companyName: "EDNA ERSOYOƒûLU", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "", currency: "TL", previousDebt: 25000.00, currentDebt: 154268.00, paid: 150000.00, documentName: "" },
            { paymentItem: "DAP METAL LTD", companyName: "DAP METAL LTD", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURALI", workName: "GZ", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "CAHƒ∞T NECƒ∞POƒûLU", companyName: "CAHƒ∞T NECƒ∞POƒûLU", iban: "", workType: "MALZEME TEDARƒ∞ƒûƒ∞", invoiceStatus: "FATURASIZ", workName: "ETKƒ∞NLƒ∞K MEYDANI", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "H√úDAVERDƒ∞ √á√ñYG√úN", companyName: "H√úDAVERDƒ∞ √á√ñYG√úN", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "ETKƒ∞NLƒ∞K MEYDANI", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ED&NA FORKLƒ∞FT Vƒ∞N√á", companyName: "", iban: "", workType: "MAKƒ∞NE EKƒ∞PMAN", invoiceStatus: "FATURALI", workName: "CASINO", currency: "USD", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "MEPA≈û", companyName: "MEPA≈û LTD", iban: "", workType: "MALZEME TEDARƒ∞ƒûƒ∞", invoiceStatus: "FATURASIZ", workName: "CASINO", currency: "USD", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "MEPA≈û", companyName: "MEPA≈û LTD", iban: "", workType: "MALZEME TEDARƒ∞ƒûƒ∞", invoiceStatus: "FATURALI", workName: "CASINO", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "MEPA≈û", companyName: "MEPA≈û LTD", iban: "", workType: "MALZEME TEDARƒ∞ƒûƒ∞", invoiceStatus: "FATURASIZ", workName: "CASINO", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ANKASAV", companyName: "ANKASAV SAVUNMA √áELƒ∞K YAPI TURƒ∞ZM ƒ∞N≈ûAAT SANAYƒ∞ VE Tƒ∞CARET LTD", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURALI", workName: "MOCK-UP 2. √úNƒ∞TE", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "ANKASAV", companyName: "ANKASAV SAVUNMA √áELƒ∞K YAPI TURƒ∞ZM ƒ∞N≈ûAAT SANAYƒ∞ VE Tƒ∞CARET LTD", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "CASINO", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "MTH FATƒ∞H AKALIN CASINO FATURA √ñDEMESƒ∞", companyName: "MTH YAPI IMALAT ENERJI YAZILIM SANAYI TICARET LIMITED SIRKETI", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURALI", workName: "CASINO", currency: "TL", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" },
            { paymentItem: "MTH FATƒ∞H AKALIN CASINO AVANS √ñDEMESƒ∞ 2.HAKEDƒ∞≈û", companyName: "MTH YAPI IMALAT ENERJI YAZILIM SANAYI TICARET LIMITED SIRKETI", iban: "", workType: "TA≈ûERON", invoiceStatus: "FATURASIZ", workName: "CASINO", currency: "EUR", previousDebt: 150000.00, currentDebt: 5000.00, paid: 150000.00, documentName: "" }
        ];

        // Auto Sync Logic
        let syncInterval = null;

        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);

            // Poll every 5 seconds (Fast)
            syncInterval = setInterval(async () => {
                // Silent check - do not update Status text constantly
                const hasUpdates = await gitHub.checkForUpdates();

                if (hasUpdates) {
                    // Beep sound (optional) or visual cue
                    updateStatus('üü° Yeni Veri Mevcut!', '#e0a800');

                    // Small toast or confirm
                    // Use a tiny timeout to not block UI thread immediately
                    setTimeout(() => {
                        if (confirm("‚ö†Ô∏è BA≈ûKA Bƒ∞R Cƒ∞HAZDA DEƒûƒ∞≈ûƒ∞KLƒ∞K YAPILDI!\n\nVeriler g√ºncellensin mi? (ƒ∞ptal derseniz √ºzerine yazma riski olu≈üur)")) {
                            initApp();
                        }
                    }, 100);
                }
            }, 5000);
        }

        let payments = []; // Will be loaded from GitHub
        let logs = []; // Log history

        // --- End GitHub Service ---

        const currencyRates = {
            TL: 1.0000,
            USD: 43.1000,
            EUR: 50.0000,
            STG: 57.8000
        };

        function updateStatus(msg, color) {
            const el = document.getElementById('connectionState');
            el.textContent = msg;
            el.style.color = color;
        }

        async function initApp() {
            // Auto Connect (Serverless)
            updateStatus('üîÑ Sunucuya baƒülanƒ±lƒ±yor...', '#ffc107');

            const data = await gitHub.loadData();
            if (data) {
                payments = data.payments || [];
                logs = data.logs || [];
                if (data.settings && data.settings.currencyRates) {
                    Object.assign(currencyRates, data.settings.currencyRates);
                }
                renderTable();
                updateStatus('üü¢ Canlƒ±', '#28a745');
                startAutoSync();
            } else {
                console.log("No data found, starting with defaults.");
                payments = JSON.parse(JSON.stringify(DEFAULT_PAYMENTS));
                renderTable();
                updateStatus('‚ö™ Varsayƒ±lan Veri', '#6c757d');
                alert("Ho≈ügeldiniz! Veri tabanƒ± bo≈ü olduƒüu i√ßin varsayƒ±lan tablo y√ºklendi. Deƒüi≈üiklik yaptƒ±ƒüƒ±nƒ±zda otomatik olu≈üturulacak.");
                startAutoSync();
            }
        }


        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            payments.forEach((payment, index) => {
                const totalDebt = (payment.previousDebt || 0) + (payment.currentDebt || 0);
                const remaining = totalDebt - (payment.paid || 0);
                const status = remaining <= 0 ? (remaining < 0 ? 'Alacaklƒ±' : '√ñdendi') : 'Bekliyor';
                const statusClass = remaining <= 0 ? 'status-paid' : 'status-pending';

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${payment.paymentItem || ''}</td>
                        <td>${payment.companyName || ''}</td>
                        <td>${payment.iban || ''}</td>
                        <td>${payment.workType || ''}</td>
                        <td>${payment.invoiceStatus || ''}</td>
                        <td>${payment.workName || ''}</td>
                        <td><strong>${payment.currency || 'TL'}</strong></td>
                        <td>${formatNumber(payment.previousDebt || 0)}</td>
                        <td>${formatNumber(payment.currentDebt || 0)}</td>
                        <td><strong>${formatNumber(totalDebt)}</strong></td>
                        <td>${formatNumber(payment.paid || 0)}</td>
                        <td><strong>${formatNumber(remaining)}</strong></td>
                        <td class="${statusClass}">${status}</td>
                        <td>${payment.documentName ? `<a href="${payment.documentUrl || '#'}" target="_blank" onclick="if(!this.href.startsWith('http')) alert('Demo dosya: ${payment.documentName}')">üìé ${payment.documentName}</a>` : '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-warning btn-sm" onclick="editPayment(${index})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayment(${index})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            updateSummary();
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function updateSummary() {
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';

            Object.keys(summary).forEach(currency => {
                const data = summary[currency];
                if (data.total > 0) {
                    summaryGrid.innerHTML += `
                    < div class="summary-item" >
                            <h4>${currency} - Toplam Bor√ß</h4>
                            <p>${formatNumber(data.total)} ${currency}</p>
                        </div >
                        <div class="summary-item">
                            <h4>${currency} - √ñdenen</h4>
                            <p>${formatNumber(data.paid)} ${currency}</p>
                        </div>
                        <div class="summary-item">
                            <h4>${currency} - Kalan</h4>
                            <p style="color: ${data.remaining > 0 ? '#dc3545' : '#28a745'}">${formatNumber(data.remaining)} ${currency}</p>
                        </div>
                `;
                }
            });
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Yeni √ñdeme Kaydƒ±';
            document.getElementById('paymentForm').reset();
            document.getElementById('editIndex').value = '';
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function editPayment(index) {
            const payment = payments[index];
            document.getElementById('modalTitle').textContent = '√ñdeme Kaydƒ±nƒ± D√ºzenle';
            document.getElementById('editIndex').value = index;
            document.getElementById('paymentItem').value = payment.paymentItem || '';
            document.getElementById('companyName').value = payment.companyName || '';
            document.getElementById('iban').value = payment.iban || '';
            document.getElementById('workType').value = payment.workType || '';
            document.getElementById('invoiceStatus').value = payment.invoiceStatus || '';
            document.getElementById('workName').value = payment.workName || '';
            document.getElementById('currency').value = payment.currency || 'TL';
            document.getElementById('previousDebt').value = payment.previousDebt || 0;
            document.getElementById('currentDebt').value = payment.currentDebt || 0;
            document.getElementById('paid').value = payment.paid || 0;
            document.getElementById('currentDocLabel').textContent = payment.documentName ? `Mevcut: ${payment.documentName} ` : '';
            document.getElementById('paymentModal').style.display = 'block';
        }

        async function savePayment() {
            const editIndex = document.getElementById('editIndex').value;
            const fileInput = document.getElementById('documentInput');

            // Upload file first if selected
            let docName = "";
            let docUrl = "";

            if (editIndex !== '' && payments[editIndex]) {
                docName = payments[editIndex].documentName;
                docUrl = payments[editIndex].documentUrl || "";
            }

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                docName = file.name;
                const uploadedUrl = await gitHub.uploadFile(file);
                if (uploadedUrl) docUrl = uploadedUrl;
            }

            const payment = {
                paymentItem: document.getElementById('paymentItem').value,
                companyName: document.getElementById('companyName').value,
                iban: document.getElementById('iban').value,
                workType: document.getElementById('workType').value,
                invoiceStatus: document.getElementById('invoiceStatus').value,
                workName: document.getElementById('workName').value,
                currency: document.getElementById('currency').value,
                previousDebt: parseFloat(document.getElementById('previousDebt').value) || 0,
                currentDebt: parseFloat(document.getElementById('currentDebt').value) || 0,
                paid: parseFloat(document.getElementById('paid').value) || 0,
                documentName: docName,
                documentUrl: docUrl
            };

            if (editIndex === '') {
                payments.push(payment);
            } else {
                payments[editIndex] = payment;
            }

            renderTable();
            closeModal();

            // Sync to GitHub
            await saveDataToGitHub(editIndex === '' ? "Yeni Kayƒ±t" : "Kayƒ±t G√ºncelleme", `${payment.companyName} - ${payment.paymentItem}`);
        }

        async function saveDataToGitHub(action, details) {
            // Add Log
            if (action) {
                logs.unshift({
                    date: new Date().toLocaleString('tr-TR'),
                    user: gitHub.user,
                    action: action,
                    details: details
                });
                // Keep last 50 logs
                if (logs.length > 50) logs.pop();
            }

            const fullData = {
                settings: { currencyRates },
                payments: payments,
                logs: logs
            };
            await gitHub.saveData(fullData);
        }

        async function deletePayment(index) {
            if (confirm('Bu kaydƒ± silmek istediƒüinizden emin misiniz?')) {
                const deleted = payments[index];
                payments.splice(index, 1);
                renderTable();
                await saveDataToGitHub("Kayƒ±t Silindi", `${deleted.companyName} - ${deleted.paymentItem}`);
            }
        }

        // --- Reports Logic ---
        function openReportsModal() {
            document.getElementById('reportsModal').style.display = 'block';
            renderCharts();
            renderLogs();
        }

        function closeReportsModal() {
            document.getElementById('reportsModal').style.display = 'none';
        }

        function renderLogs() {
            const list = document.getElementById('logList');
            list.innerHTML = '';
            if (logs.length === 0) {
                list.innerHTML = '<li style="color:#999; text-align:center;">Hen√ºz i≈ülem kaydƒ± yok.</li>';
                return;
            }
            logs.forEach(log => {
                list.innerHTML += `<li style="border-bottom:1px solid #ddd; padding:8px 0; font-size:13px;">
                    <strong>[${log.date}]</strong> 
                    <span style="color:#667eea">${log.user}</span>: 
                    <b>${log.action}</b> - ${log.details}
                </li>`;
            });
        }

        let charts = {};
        function renderCharts() {
            const ctx1 = document.getElementById('currencyChart').getContext('2d');
            const ctx2 = document.getElementById('statusChart').getContext('2d');

            // Destroy existing if any
            if (charts.c1) charts.c1.destroy();
            if (charts.c2) charts.c2.destroy();

            // Prepare Data 1: Debt by Currency
            const debtByCurrency = {};
            payments.forEach(p => {
                const debt = (p.previousDebt || 0) + (p.currentDebt || 0) - (p.paid || 0);
                if (debt > 0) {
                    debtByCurrency[p.currency] = (debtByCurrency[p.currency] || 0) + debt;
                }
            });

            charts.c1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(debtByCurrency),
                    datasets: [{
                        label: 'Para Birimine G√∂re Kalan Bor√ß',
                        data: Object.values(debtByCurrency),
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Prepare Data 2: Status Distribution
            let statusCounts = { '√ñdendi': 0, 'Bekliyor': 0, 'Alacaklƒ±': 0 };
            payments.forEach(p => {
                const total = (p.previousDebt || 0) + (p.currentDebt || 0);
                const remaining = total - (p.paid || 0);
                const s = remaining <= 0 ? (remaining < 0 ? 'Alacaklƒ±' : '√ñdendi') : 'Bekliyor';
                statusCounts[s]++;
            });

            charts.c2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#28a745', '#dc3545', '#17a2b8']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function updateCurrencyRates() {
            const usd = prompt('USD Kuru (‚Ç∫):', currencyRates.USD);
            const eur = prompt('EUR Kuru (‚Ç∫):', currencyRates.EUR);
            const stg = prompt('STG Kuru (‚Ç∫):', currencyRates.STG);

            if (usd) {
                currencyRates.USD = parseFloat(usd);
                document.getElementById('usdRate').textContent = '‚Ç∫' + usd;
            }
            if (eur) {
                currencyRates.EUR = parseFloat(eur);
                document.getElementById('eurRate').textContent = '‚Ç∫' + eur;
            }
            if (stg) {
                currencyRates.STG = parseFloat(stg);
                document.getElementById('stgRate').textContent = '‚Ç∫' + stg;
            }

            alert('Kurlar g√ºncellendi!');
        }

        function exportToExcel() {
            // Define headers matching the exact requested structure
            const headers = [
                "SIRA NO", "√ñDEME KALEMLERƒ∞", "Fƒ∞RMA FATURA ƒ∞SMƒ∞", "Fƒ∞RMA ƒ∞BANLARI",
                "ƒ∞≈ûƒ∞N NEVƒ∞", "FATURA DURUMU", "ƒ∞≈ûƒ∞N ADI", "PARA Bƒ∞Rƒ∞Mƒ∞",
                "√ñNCEKƒ∞ D√ñNEMDEN KALAN BOR√á", "BU AYKƒ∞ BOR√á", "TOPLAM BO√á",
                "BU AY √ñDENEN", "KALAN", "√ñDEME DURUMU", "EVRAK Y√úKLEME (PDF-JPG )"
            ];

            // Map data to rows
            const rows = payments.map((p, i) => {
                const total = (p.previousDebt || 0) + (p.currentDebt || 0);
                const remaining = total - (p.paid || 0);
                const status = remaining <= 0 ? (remaining < 0 ? 'Alacaklƒ±' : '√ñdendi') : 'Bekliyor';
                const statusSymbol = remaining <= 0 ? '√º' : 'x'; // Matching Excel style symbols if needed, or text

                return [
                    i + 1,
                    p.paymentItem,
                    p.companyName,
                    p.iban,
                    p.workType,
                    p.invoiceStatus,
                    p.workName,
                    p.currency,
                    p.previousDebt,
                    p.currentDebt,
                    total,
                    p.paid,
                    remaining,
                    statusSymbol,
                    p.documentName
                ];
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "OCAK 2026 D√ñNEMƒ∞ √ñDEMELER");

            // Save file
            XLSX.writeFile(wb, "odeme_takip_tablosu.xlsx");
        }

        function importExcel(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Get all data as array of arrays
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Find the header row (looking for "SIRA NO" or similar)
                let headerRowIndex = -1;
                for (let i = 0; i < jsonData.length; i++) {
                    if (jsonData[i].some(cell => cell && cell.toString().includes("SIRA"))) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    alert("Uygun formatta tablo bulunamadƒ±!");
                    return;
                }

                // Process rows after header
                const newPayments = [];
                for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue; // Skip empty rows

                    // Map columns based on fixed index from the provided Excel file structure
                    // 0: Empty/NaN usually
                    // 1: SIRA NO
                    // 2: √ñDEME KALEMLERƒ∞
                    // 3: Fƒ∞RMA FATURA ƒ∞SMƒ∞
                    // 4: Fƒ∞RMA ƒ∞BANLARI
                    // 5: ƒ∞≈ûƒ∞N NEVƒ∞
                    // 6: FATURA DURUMU
                    // 7: ƒ∞≈ûƒ∞N ADI
                    // 8: PARA Bƒ∞Rƒ∞Mƒ∞
                    // 9: √ñNCEKƒ∞ D√ñNEM
                    // 10: BU AYKƒ∞
                    // 11: TOPLAM (Calculated usually, but import if needed)
                    // 12: BU AY √ñDENEN
                    // 13: KALAN (Calculated)
                    // 14: DURUM
                    // 15: EVRAK

                    // Simple check to ensure row has data
                    if (!row[2] && !row[3]) continue;

                    newPayments.push({
                        paymentItem: row[2] || "",
                        companyName: row[3] || "",
                        iban: row[4] || "",
                        workType: row[5] || "",
                        invoiceStatus: row[6] || "",
                        workName: row[7] || "",
                        currency: row[8] || "TL",
                        previousDebt: parseFloat(row[9]) || 0,
                        currentDebt: parseFloat(row[10]) || 0,
                        paid: parseFloat(row[12]) || 0,
                        documentName: row[15] || ""
                    });
                }

                if (confirm(`${newPayments.length} kayƒ±t bulundu.Mevcut listenin √ºzerine yazƒ±lsƒ±n mƒ± ?`)) {
                    payments = newPayments;
                    renderTable();
                    alert("Tablo ba≈üarƒ±yla y√ºklendi!");
                }
                // Reset input
                document.getElementById('excelImportInput').value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('paymentModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function saveSettings() {
            const token = document.getElementById('githubToken').value;
            const user = document.getElementById('githubUser').value;
            const repo = document.getElementById('githubRepo').value;
            const path = document.getElementById('githubPath').value;

            gitHub.updateCredentials(token, user, repo, path);
        }

        async function testConnection() {
            await saveSettings();
            await initApp();
        }

        // Initialize table on page load
        // renderTable(); // Removed, handled by initApp
        initApp();
    </script>
</body>

</html>